{% comment %}
	GSAP Marquee Snippet
	Usage: {% render 'gsap-marquee', image_src: 'image-2061301e-6486-4b3b-ab59-5f88270f16d6.webp', speed: 20 %}

	Parameters:
	- image_src: The image filename to use for the marquee
	- speed: Animation speed in pixels per second (default: 20)
	- direction: 'left' or 'right' (default: 'left')
	- image_count: Number of images to duplicate (default: 15)
{% endcomment %}

{% assign speed = speed | default: 40 %}
{% assign direction = direction | default: 'left' %}
{% assign image_count = image_count | default: 15 %}

<section class="gsap-marquee-section">
	<div class="gsap-marquee-component">
		<div class="gsap-marquee-wrapper">
			<div
				class="gsap-marquee-track"
				data-speed="{{ speed }}"
				data-direction="{{ direction }}">
				{% comment %} First set of items {% endcomment %}
				{% for i in (1..image_count) %}
					<div class="gsap-marquee-item">
						<img
							src="{{ image_src | asset_url }}"
							alt=""
							loading="lazy"
							width="60"
							height="60"
							class="gsap-marquee-image">
					</div>
				{% endfor %}
				{% comment %} Duplicate set for seamless loop {% endcomment %}
				{% for i in (1..image_count) %}
					<div class="gsap-marquee-item">
						<img
							src="{{ image_src | asset_url }}"
							alt=""
							loading="lazy"
							width="60"
							height="60"
							class="gsap-marquee-image">
					</div>
				{% endfor %}
			</div>
		</div>
	</div>
</section>

<style>
	.gsap-marquee-section {
		width: 100vw;
		max-width: 100%;
		overflow: hidden;
		/* Safari optimization */
		-webkit-transform: translateZ(0);
		transform: translateZ(0);
	}

	.gsap-marquee-component {
		width: 100%;
		display: flex;
	}

	.gsap-marquee-wrapper {
		border-top: 1px solid var(--color-scheme-1--color);
		border-bottom: 1px solid var(--color-scheme-1--color);
		width: 200vw;
		display: flex;
	}

	.gsap-marquee-track {
		justify-content: space-around;
		align-items: center;
		width: 100vw;
		padding-top: 1rem;
		padding-bottom: 1rem;
		display: flex;
		/* Safari-specific optimizations */
		-webkit-transform: translate3d(0, 0, 0);
		transform: translate3d(0, 0, 0);
		-webkit-backface-visibility: hidden;
		backface-visibility: hidden;
		-webkit-perspective: 1000px;
		perspective: 1000px;
		/* Use will-change only when animation is active */
		will-change: auto;
	}

	/* Safari-specific class for when animation is active */
	.gsap-marquee-track.animating {
		will-change: transform;
		-webkit-transform: translate3d(0, 0, 0);
		transform: translate3d(0, 0, 0);
	}

	.gsap-marquee-item {
		justify-content: center;
		align-items: center;
		padding-left: 0;
		padding-right: 0;
		margin-left: 1rem;
		margin-right: 1rem;
		display: flex;
		flex-shrink: 0;
		/* Safari optimization for flex items */
		-webkit-flex-shrink: 0;
	}

	.gsap-marquee-image {
		aspect-ratio: 1;
		object-fit: cover;
		width: 100%;
		height: 100%;
		max-height: 4rem;
		max-width: 4rem;
		/* Safari optimization for images */
		-webkit-transform: translateZ(0);
		transform: translateZ(0);
		-webkit-backface-visibility: hidden;
		backface-visibility: hidden;
	}

	/* Mobile-specific styles */
	@media screen and (max-width: 768px) {
		.gsap-marquee-image {
			max-height: 2.5rem;
			max-width: 2.5rem;
		}

		.gsap-marquee-item {
			margin-left: 0.5rem;
			margin-right: 0.5rem;
		}

		.gsap-marquee-track {
			padding-top: 0.5rem;
			padding-bottom: 0.5rem;
		}
	}

	/* Small mobile devices */
	@media screen and (max-width: 480px) {
		.gsap-marquee-image {
			max-height: 2rem;
			max-width: 2rem;
		}

		.gsap-marquee-item {
			margin-left: 0.25rem;
			margin-right: 0.25rem;
		}
	}

	/* Safari-specific media query for better performance */
	@media screen and (-webkit-min-device-pixel-ratio: 0) {
		.gsap-marquee-track {
			-webkit-transform: translate3d(0, 0, 0);
			transform: translate3d(0, 0, 0);
		}
	}

	/* CSS Fallback animations for when JavaScript fails */
	@keyframes marquee-left {
		0% {
			transform: translateX(0);
		}
		100% {
			transform: translateX(-50%);
		}
	}

	@keyframes marquee-right {
		0% {
			transform: translateX(-50%);
		}
		100% {
			transform: translateX(0);
		}
	}

	/* CSS fallback class */
	.gsap-marquee-track.css-fallback {
		animation: marquee-left 20s linear infinite;
		will-change: transform;
	}

	/* Mobile-optimized CSS fallback */
	@media screen and (max-width: 768px) {
		.gsap-marquee-track.css-fallback {
			animation: marquee-left 15s linear infinite;
		}
	}

	/* Safari-specific CSS fallback */
	@media screen and (-webkit-min-device-pixel-ratio: 0) {
		.gsap-marquee-track.css-fallback {
			-webkit-animation: marquee-left 20s linear infinite;
			animation: marquee-left 20s linear infinite;
		}
	}
</style>

<script>
	// Safari-specific initialization for marquee
	(function () {
		// Wait for DOM to be ready
		if (document.readyState === 'loading') {
			document.addEventListener('DOMContentLoaded', initMarquee);
		} else {
			initMarquee();
		}

		function initMarquee() {
			const tracks = document.querySelectorAll('.gsap-marquee-track');

			tracks.forEach(track => {
				// Force Safari to calculate dimensions properly
				track.style.display = 'none';
				track.offsetHeight; // Force reflow
				track.style.display = 'flex';

				// Safari-specific: Ensure images are loaded before animation starts
				const images = track.querySelectorAll('.gsap-marquee-image');
				let loadedImages = 0;

				images.forEach(img => {
					if (img.complete) {
						loadedImages++;
					} else {
						img.addEventListener(
							'load',
							() => {
								loadedImages++;
								if (loadedImages === images.length) {
									// All images loaded, trigger animation initialization
									setTimeout(() => {
										if (window.GenskinsAnimations && window.GenskinsAnimations.initGSAPMarquees) {
											window.GenskinsAnimations.initGSAPMarquees();
										}
									}, 100);
								}
							},
							{ once: true }
						);
					}
				});

				// If all images are already loaded
				if (loadedImages === images.length) {
					setTimeout(() => {
						if (window.GenskinsAnimations && window.GenskinsAnimations.initGSAPMarquees) {
							window.GenskinsAnimations.initGSAPMarquees();
						}
					}, 100);
				}
			});
		}
	})();
</script>
